<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
	<title>Django Models in no time</title>
	<meta name="description" content="The in-browser tool allowing you to quickly prototype the Django models.py and admin.py code blocks. JavaScript-based, no data sent out.">
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<style type="text/css">
		body { margin:0; padding:0; font: 12px/1.4em Verdana,sans-serif; }
		#header { background: none repeat scroll 0 0 #092E20; height: 6.5em; position: relative; color: white; }
		#header a, #header a:visited { color: white }
		#content a, #content a:visited { color: #AB5603 }
		#header #logo { bottom: 10px; height: 41px; left: 25px; margin:0; position: absolute; }
		#header #hdr { bottom: 0px; height: 40px; left: 150px; margin:0; position: absolute; font-size: 200%; color: #E0FFB8}
		#header #contact { right: 10px; height: 35px; bottom: 0px; position:absolute; color: #FFC757 }
		#content { padding: 1em; }
		#prefs { width: 80em; padding: 0 }
		#prefs li { width: 30em; display: inline-block; }
		.comment { font-style: italic; font-size: 90% }
		#dst-container { width: 60em }
		#dst_code { min-height: 75em }
		textarea { vertical-align: top }
		.nowrap { white-space: nowrap }
		pre {
			margin: 0; padding: 0;
			display: inline-block;
			white-space: pre-wrap; /* css-3 */
			white-space: -moz-pre-wrap !important; /* Mozilla, since 1999 */
			white-space: -pre-wrap; /* Opera 4-6 */
			white-space: -o-pre-wrap; /* Opera 7 */
			word-wrap: break-word; /* Internet Explorer 5.5+ */
		}
	</style>
	<link rel="stylesheet" href="http://yandex.st/highlightjs/6.1/styles/github.css">
</head>
<body>
	<div id="header">
		<span id="logo"><a href="https://www.djangoproject.com/"><img src="https://www.djangoproject.com/m/img/site/hdr_logo.gif" alt="Django"></a></span>
		<span id="hdr">Models in no time</span>
		<span id="contact">Created by <a href="http://www.linkedin.com/in/vladamacek/">Vláďa Macek</a>,
		Feb 2012+,
		<a href="mailto:macek@sandbox.cz?subject=Feedback:%20Django%20models%20in%20no%20time">feedback</a>
		is welcome. Or <a href="https://github.com/tuttle/python-useful/issues">file an Issue</a>.</span>
	</div>

	<div id="content">
		<form name="form" action="">
		<ul id="prefs">
			<li>
				Verbose names:
				<input type="radio" name="verb" value="" id="verb0" onchange="compute()"
				><label for="verb0">Off</label>
				<input type="radio" name="verb" value="verbnames" id="verb1" checked="checked" onchange="compute()"
				><label for="verb1">On</label>
				<input type="radio" name="verb" value="gettext" id="verb2" onchange="compute()"
				><label for="verb2">Gettext</label>
			</li>
			<li>
				Base:
				<input type="radio" name="base" value="models.Model" id="base0" checked="checked" onchange="compute()"
				><label for="base0">models.Model</label>
				<input type="radio" name="base" value="TimeStampedModel" id="base1" onchange="compute()"
				><label for="base1">TimeStampedModel</label>
			</li>
			<li>
				Widget:
				<input type="radio" name="widget" value="" id="widget0" onchange="compute()"
				><label for="widget0">Textarea</label>
				<input type="radio" name="widget" value="colorcode" id="widget1" checked="checked" onchange="compute()"
				><label for="widget1">Colored code</label>
			</li>
			<li class="comment">These preferences are remembered in a cookie.</li>
		</ul>
		<p><strong>Supported field types:</strong> bo boz in inz ch chz tx txz dt dtz dd ddz fk fkz mm mmz js</p>

		<div class="nowrap"><textarea onKeyUp="compute()" name="src" rows="60" cols="40">
Category
ch name

Post
ch name
bo active
fk category
dt posted_at
txz body
in score
js details
</textarea>
		<span style="vertical-align: top; font-size: 30px">&rarr;</span>
		<pre id="dst-container"><code id="dst_code" class="python">Code</code></pre>
		<textarea name="dst_area" style="display: none" rows="60" cols="100" readonly="readonly"></textarea>
		</div>
		</form>

		<br>
		<p><strong>Please note:</strong> The generated code is not guaranteed to work right away.
		It is intended to spare you the primary typing work. Not rushing to have every field or feature supported, <a href="http://en.wikipedia.org/wiki/KISS_principle">KISS</a>ing instead.</p>

		<p><strong>Privacy note:</strong> DMint uses local JavaScript, sends nothing anywhere.</p>

		<p class="comment">
		Developed using Firefox on Linux. MIT licensed, feedback appreciated.
		(Header design and logo from <a href="http://djangoproject.com/">http://djangoproject.com/</a>.
		Using the wonderful <a href="http://softwaremaniacs.org/soft/highlight/en/">highlight.js</a> library.)
		</p>
	</div>
	<script src="http://yandex.st/highlightjs/6.1/highlight.min.js" type="text/javascript"></script>

	<script type="text/javascript">
var f = document.form, dst_code = document.getElementById('dst_code');
var old_prefs = get_cookie();

function get_radio(field) {
	for (var i=0; i<field.length; i++)
		if (field[i].checked) return field[i].value;
}

function camelize(str) {
	var s = str.replace(/_(.)/g, function (x, chr) { return chr.toUpperCase() });
	return s.charAt(0).toUpperCase() + s.slice(1);
};

function uncamelize(str) {
	if (!str) return '';
	return str.replace(/\W+/g, '_').replace(/([a-z\d])([A-Z])/g, '$1_$2').toLowerCase();
};

function humanize_field(str) {
	return str.replace(/_(.)/g, function (x, chr) { return ' ' + chr });
};

function humanize_class(str) {
	return uncamelize(str).replace('_', ' ');
};

function pluralize(s) {
	if (s.slice(-1) == 'y') s = s.slice(0, -1) + 'ies'
	else if (s.slice(-1) == 's') s = s.slice(0, -1) + 'ses'
	else if (s.slice(-2) == 'ch') s = s.slice(0, -2) + 'ches'
	else s += 's';
	return s;
};

function set_cookie(value) {
	var cs = 'modelsinnotimeprefs=' + escape(value);
	cs += "; expires=" + (new Date(2100,1,1)).toGMTString();
	document.cookie = cs;
}

function get_cookie() {
	var results = document.cookie.match('(^|;) ?modelsinnotimeprefs=([^;]*)(;|$)');
	return (results) ? unescape(results[2]) : '';
}

function compute() {
	var verb = get_radio(f.verb), base = get_radio(f.base), widget = get_radio(f.widget);
	var i, oM='', oMN = new Array(), oA='', oAL;
	var oAR='', oI='from django.db import models\n', blocks=f.src.value.split(/\r?\n\r?\n/);
	var prefs = verb + ' ' + base + ' ' + widget;

	if (old_prefs != prefs) {
		set_cookie(prefs);
		old_prefs = prefs;
	}

	if (verb == 'gettext')
		oI += 'from django.utils.translation import ugettext_lazy as _\n';
	if (base == 'TimeStampedModel')
		oI += 'from django_extensions.db.models import TimeStampedModel\n';
	if (widget == 'colorcode') {
		dst_code.parentNode.style.display = 'inline-block';
		f.dst_area.style.display = 'none';
	} else {
		dst_code.parentNode.style.display = 'none';
		f.dst_area.style.display = 'inline-block';
	};

	for (i=0; i<blocks.length; i++) {
		if (!blocks[i]) continue;
		var j, lines = blocks[i].split(/\r?\n/);
		oM += 'class ' + lines[0] + '(' + base + '):\n';
		oMN.push(lines[0]);
		oAL = new Array();
		oAR += 'admin.site.register(' + lines[0] + ', ' + lines[0] + 'Admin)\n';

		for (j=1; j<lines.length; j++) {
			var lt = lines[j].split(' ');
			if (!lt[0]) continue;
			var fld = lt[1] || '';
			var cmd = lt[0].slice(0,2).toLowerCase();
			if (cmd != 'mm') oAL.push(fld);
			var fldh = humanize_field(fld);
			fldh = (verb == 'gettext') ? '_("' + fldh + '")' : '"' + fldh + '"';
			//console.log(lt, fld);
			switch (cmd) {
			  case 'ch':	oM += '    ' + fld + ' = models.CharField(';
					if (verb) oM += fldh + ', ';
					if (lt[0][2] == 'z') oM += 'blank=True, ';
					oM += 'max_length=255)\n';
					break;
			  case 'tx':	oM += '    ' + fld + ' = models.TextField(';
					if (verb) oM += fldh;
					if (verb && (lt[0][2] == 'z')) oM += ', ';
					if (lt[0][2] == 'z') oM += 'blank=True';
					oM += ')\n';
					break;
			  case 'in':	oM += '    ' + fld + ' = models.IntegerField('
					if (verb) oM += fldh;
					if (verb && (lt[0][2] == 'z')) oM += ', ';
					if (lt[0][2] == 'z') oM += 'blank=True, null=True';
					oM += ')\n';
					break;
			  case 'dt':	oM += '    ' + fld + ' = models.DateTimeField(';
					if (verb) oM += fldh;
					if (verb && (lt[0][2] == 'z')) oM += ', ';
					if (lt[0][2] == 'z') oM += 'blank=True, null=True';
					oM += ')\n';
					break;
			  case 'dd':	oM += '    ' + fld + ' = models.DateField(';
					if (verb) oM += fldh;
					if (verb && (lt[0][2] == 'z')) oM += ', ';
					if (lt[0][2] == 'z') oM += 'blank=True, null=True';
					oM += ')\n';
					break;
			  case 'js':	oI = 'from django.contrib.postgres.fields import JSONField\n' + oI;
					oM += '    ' + fld + ' = JSONField(';
					if (verb) oM += fldh;
					oM += ')\n';
					break
			  case 'fk':    oM += '    ' + fld + ' = models.ForeignKey(' + camelize(fld);
					if (verb) oM += ', verbose_name=' + fldh;
					if (lt[0][2] == 'z') oM += ', blank=True, null=True';
					//oM += ", related_name='" + pluralize(uncamelize(lines[0])) + "'";
					oM += ", on_delete=models.CASCADE|PROTECT|SET()|SET_NULL|SET_DEFAULT|DO_NOTHING)\n";
					break;
			  case 'mm':    oM += '    ' + pluralize(fld) + ' = models.ManyToManyField(' + camelize(fld);
					if (verb) {
						fldh = humanize_field(pluralize(fld));
						fldh = (verb == 'gettext') ? '_("' + fldh + '")' : '"' + fldh + '"';
						oM += ', verbose_name=' + fldh;
					}
					if (lt[0][2] == 'z') oM += ', blank=True';
					//oM += ", related_name='" + pluralize(uncamelize(lines[0])) + "')
					oM += ")\n";
					break;
			  case 'bo':    oM += '    ' + fld + ' = models.';
					oM += (lt[0][2] == 'z') ? 'NullBooleanField(' : 'BooleanField(';
					if (verb) oM += fldh + ', ';
					oM += "default=False)\n";
					break;
			  default:
					oM += '# line unrecognized: ' + lines[j] + '\n';
			}
		}
		oM += '\n';
		if (verb == 'gettext') {
			var hc = humanize_class(lines[0]);
			oM += '    class Meta:\n';
			oM += '        verbose_name = _("' + hc + '")\n';
			oM += '        verbose_name_plural = _("' + pluralize(hc) + '")\n';
		} else {
			oM += '#    class Meta:\n';
		}
		oM += '#        unique_together = ()\n';
		oM += '#        index_together = ()\n\n';

		oA += 'class ' + lines[0] + "Admin(admin.ModelAdmin):\n";
		oA += '    list_display = (';
		if (base == 'TimeStampedModel') oA += "'created', ";
		if (oAL && oAL.length) {
			oM += '    def __unicode__(self):\n        return self.' + oAL[0] + '\n\n\n';
			oA += "'" + oAL.join("', '") + "'";
			if ((oAL.length == 1) && (base != 'TimeStampedModel')) oA += ', ';
		}
		oA += ")\n    list_filter = ()\n    search_fields = ()\n    date_hierarchy = '";
		if (base == 'TimeStampedModel') oA += 'created';
		oA += "'\n\n\n";
	}
	var o = oI + '\n\n' + oM + '# admin.py:\nfrom django.contrib import admin\n\nfrom .models import ' + oMN.join(', ') + '\n\n\n' + oA + oAR;
	if (widget == 'colorcode') {
		dst_code.textContent = o;
		hljs.highlightBlock(dst_code);
	} else f.dst_area.value = o;
};

if (old_prefs) {
	var chi = (old_prefs.indexOf('gettext') != -1) ? 2 : (old_prefs.indexOf('verbnames') != -1) ? 1 : 0;
	f.verb[chi].checked = true;
	chi = (old_prefs.indexOf('TimeStampedModel') != -1) ? 1 : 0;
	f.base[chi].checked = true;
	chi = (old_prefs.indexOf('colorcode') != -1) ? 1 : 0;
	f.widget[chi].checked = true;
}

compute();
f.src.focus();
f.src.select();
	</script>
</body>
</html>
